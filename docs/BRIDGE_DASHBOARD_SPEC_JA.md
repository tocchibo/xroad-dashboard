# Municipal Bridge Dashboard アプリ 仕様書 / 要件定義書

## 1. ドキュメント概要

### 1.1 目的

本ドキュメントは、自治体が管理する道路橋の施設一覧 CSV をもとに、  
橋梁ストック構成・点検判定状況・総延長分布・架設年度分布・地理的分布を可視化する  
Web ダッシュボードアプリの仕様書兼要件定義書である。

特に、別途用意される「分析例」ドキュメントに記載されたグラフ構成・整理の仕方に最大限準拠することを主目的とする。

### 1.2 対象読者

- 人間の開発者
- AI エージェント（コード生成・設計補助を行うツール）

### 1.3 想定利用シナリオ

- 自治体ごとに作成された橋梁施設一覧 CSV をローカルから読み込む
- 複数自治体の CSV をまとめて読み込み、ストック・健全度・分布をダッシュボードで確認する
- GitHub Pages 上の静的サイトとして公開し、ブラウザのみで利用する

---

## 2. システム概要

### 2.1 システム名（仮）

Municipal Bridge Dashboard（自治体向け橋梁ダッシュボード）

### 2.2 全体像

- クライアントサイドのみで完結する静的 Web アプリ
- HTML + JavaScript + CSS のみで構成
- 外部ライブラリはすべて CDN 経由で読み込む
- サーバサイド処理や DB は持たない
- ローカル CSV ファイルをユーザー操作（ファイル選択・ドラッグ＆ドロップ）で読み込み、ブラウザ内メモリで解析・可視化する

### 2.3 入出力概要

- 入力: 自治体ごとの橋梁施設一覧 CSV（1 ファイル = 1 自治体）
- 出力: ブラウザ上のグラフ・表・地図によるダッシュボード表示
- データ保存: ブラウザ外部（サーバ等）には保存しない。必要に応じてユーザーがスクリーンショットやエクスポートを行う。

### 2.4 AI エージェント利用方針

- AI エージェントは本仕様書に準拠して設計・実装・リファクタリングを行う
- 仕様が不明瞭な箇所を「場当たり的な条件分岐」で処理することは厳禁とする
- 仕様に不明点がある場合は、仕様書の「未決事項」を確認し、必要に応じてユーザーへ確認を求めること
- 本仕様書に記載のない機能追加は、ユーザーから明示的な指示があるまで行わない

---

## 3. データ仕様

### 3.1 入力 CSV の必須列

現時点で利用できる列は以下とする。列名はヘッダ行に日本語で記載されている前提とする。

- `施設名`
- `路線名`
- `架設年度_西暦`
- `橋長(m)`
- `径間数`
- `上部工（使用材料）`
- `道路管理者_名称`
- `道路管理者_管理事務所名`
- `起点側位置_緯度`
- `起点側位置_経度`
- `点検記録_点検実施年月`
- `点検記録_判定区分`

その他の列が存在する場合でも、本仕様書では上記のみを前提とする。  
追加列を利用した分析は、将来の拡張とする。

#### 3.1.1 文字コード・区切り文字

- 文字コード、区切り文字（カンマ / タブ等）は実データに依存する
- 現時点では「未決事項」とし、実データ確認後に決定する（→ 5.1 を参照）

### 3.2 データ単位と管理主体の取り扱い

- 1 つの CSV ファイルには、**単一の管理自治体**が管理する橋梁のみが含まれる前提とする
- `道路管理者_名称` は、1 ファイル中で基本的に同一であるとみなしてよい
- アプリ内部では、以下のように扱う
  - `datasetId`: 読み込んだファイルごとに一意な ID を付与
  - `datasetLabel`: ファイル名または `道路管理者_名称` の値を用いて表示名とする

### 3.3 橋種カテゴリの定義

分析・地図表示で用いる橋種カテゴリは、次の 4 区分とする。

- PC 橋
- RC 橋
- 鋼橋
- その他

`上部工（使用材料）` の文字列から上記 4 区分にマッピングする。

#### 3.3.1 マッピング仕様（決定事項）

- アプリ側で「マッピングルール（辞書）」を持ち、`上部工（使用材料）` の値を走査して橋種カテゴリに変換する
- マッピングは基本的に「部分一致」や「正規表現」で判定する

例（実際のルールは別途決定する）:

- 値に「PC」を含む → PC 橋
- 値に「RC」を含む → RC 橋
- 値に「鋼」を含む → 鋼橋
- 上記いずれにも該当しない → その他

#### 3.3.2 マッピング仕様（未決事項）

- 実際に出現する `上部工（使用材料）` の値の具体的なバリエーション
- 「PC 合成桁」「PC 中空床版」など細分類をどこまで一括りにするか
- 「鋼合成桁」「PRC」など、複合的な表現の扱い

これらは実データ確認後、マッピングテーブルとして明示的に定義する必要がある（→ 5.2）。

### 3.4 判定区分の正規化

`点検記録_判定区分` は、基本的に I, II, III, IV 等の値を取る想定とする。

#### 3.4.1 決定事項

- 内部的には、以下のように正規化する

  - I, Ⅰ, 1 → "I"
  - II, Ⅱ, 2 → "II"
  - III, Ⅲ, 3 → "III"
  - IV, Ⅳ, 4 → "IV"

- グラフ・地図上では "I"〜"IV" をキーとして扱う
- 不明な値（空欄・その他記号）は "UNKNOWN" カテゴリとして集計する

#### 3.4.2 未決事項

- 「IIIa」「III-1」等の亜種が存在する場合の扱い（III に丸めるか、別カテゴリにするか）
- 点検を未実施の橋梁をどのように扱うか（別途「未点検」として扱うか）

---

## 4. 機能要件

### 4.1 CSV 読み込み機能

#### 4.1.1 複数ファイル読み込み

- ユーザーは、ファイル選択（`<input type="file" multiple>`）またはドラッグ＆ドロップにより、複数の CSV ファイルを一度に読み込むことができる
- 各ファイルは 1 つの dataset として扱う

#### 4.1.2 追加読み込み

- 初回読み込み後も、ユーザーは追加で CSV を読み込むことができる
- 追加読み込みした dataset は既存の dataset に加算され、分析・可視化結果に反映される
- 同一ファイルを重複して読み込んだ場合の扱いは未決（→ 5.3）

#### 4.1.3 CSV パース

- CSV パースには CDN 経由のライブラリ（例: Papa Parse）を利用する
- ヘッダ行から列名を取得し、3.1 の列が存在することを検証する
- 必須列が欠けている場合は、そのファイルをスキップし、ユーザーにエラー表示を行う

### 4.2 分析・可視化機能（分析例準拠）

#### 4.2.1 分析例との整合性（共通方針）

- 別途用意される「分析例」ドキュメントに記載されたグラフ・集計の構成を可能な限り踏襲する
- ただし、現 CSV に存在しない項目（例: 修繕実績・費用・計画情報など）を前提とする分析は実装対象外とする
- 分析例と完全に一致させられない場合は、以下の代替方針を取る
  - 同じコンセプト（例: 「劣化リスクの分布」）を、利用可能な項目（判定区分・架設年代・橋種など）で表現する
  - 欠落情報に依存するグラフは「将来拡張」として整理し、UI 上で区別できるようにする（未決）

#### 4.2.2 ストック構成（橋種別・延長別）

**目的**  
管理橋梁の構成を橋種別・延長ベース・本数ベースで把握する。

**要件**

- 橋種カテゴリ（PC/RC/鋼/その他）別に以下を集計し、棒グラフまたは円グラフ等で表示する
  - 橋梁数
  - 総延長（`橋長(m)` の合計）
- 管理主体（dataset ごと）でフィルタ・集計できる
  - 単一自治体のみ
  - 全自治体合算
- 可能であれば、分析例と同様のグラフレイアウト（例: 上段に橋梁数、下段に総延長）を踏襲する

#### 4.2.3 判定区分の分布

**目的**  
点検判定区分の全体分布と属性別の偏りを可視化する。

**要件**

- 正規化済みの判定区分（I〜IV・UNKNOWN）ごとに橋梁数を集計し、棒グラフ等で表示する
- 橋種別 × 判定区分のクロス集計を行い、スタック棒グラフまたはグループ棒グラフで表示する
- 橋長階級（例: 0–10, 10–20, ... m）× 判定区分の分布を集計し、ヒートマップ等で表示することも検討対象とする（実装は任意 / 未決）

#### 4.2.4 総延長分布（橋長分布）

**目的**  
橋長の分布（本数・延長）を把握する。

**要件**

- 橋長階級（例: 0–10, 10–20, ... m）のヒストグラムを作成し、以下を表示する
  - 各階級の橋梁数
  - 各階級の総延長
- 橋種別フィルタ（PC/RC/鋼/その他）を提供し、特定の橋種の橋長分布を確認できるようにする

階級幅や最大値の扱いは未決だが、デフォルト案を仕様として持つ（→ 5.4）。

#### 4.2.5 架設年度分布

**目的**  
架設年度の分布から、老朽橋のポテンシャルを把握する。

**要件**

- 架設年度_西暦をもとに、以下のいずれかの方法で分布を表示する
  - 年単位のヒストグラム
  - 10 年階級（例: 1960〜1969, 1970〜1979, ...）のヒストグラム
- 橋種別 × 架設年代の構成比を可視化する（スタック棒グラフ等）
- 判定区分との関係（例: 架設年代 × 判定区分）も表示できるのが望ましいが、実装優先度は中とする

#### 4.2.6 地理的分布（地図表示）

**目的**  
地理的にどこに橋が集中しているか、問題のある橋がどこに分布しているかを可視化する。

**要件**

- Leaflet + OpenStreetMap などの地図ライブラリを CDN 経由で利用し、地図上に橋梁をプロットする
- 各橋梁は以下のルールで可視化する
  - 色: `点検記録_判定区分` に応じて変える  
    - 例: I=緑, II=黄, III=橙, IV=赤, UNKNOWN=灰
  - 形/マーカー種別: 橋種カテゴリに応じて変える  
    - PC 橋, RC 橋, 鋼橋, その他でアイコンを変えるか、マーカー形状を変える
- 凡例（色と形の対応）を必ず表示する
- dataset ごと（自治体ごと）の表示 ON/OFF を切り替える UI を持つ
- 緯度・経度が欠損しているレコードは地図には表示せず、件数だけ別途集計することが望ましい（未実装でもよい）

### 4.3 UI / UX 要件（確定事項）

- 単一ページ構成のダッシュボード
- 主な UI コンポーネント:
  - CSV 読み込みエリア（ファイル選択ボタン + ドロップゾーン）
  - 読み込み済み dataset の一覧（自治体名 / ファイル名）
  - フィルタ設定（自治体選択、橋種選択、判定区分選択 等）
  - グラフエリア（タブ or セクションで複数グラフを切り替え）
  - 地図エリア
- レイアウトはレスポンシブであることが望ましいが、まずは PC 画面（横幅 1200px 程度）での利用を優先する
- 表示言語は日本語とする

### 4.4 技術要件

#### 4.4.1 フロントエンド構成

- `index.html` から始まる静的サイト
- JavaScript コードは `js/` ディレクトリに配置する
  - 例: `js/main.js`, 必要に応じて `js/chart.js`, `js/map.js` などに分割
- CSS は `css/` ディレクトリに配置するか、`index.html` 内の `<style>` で定義してもよい

#### 4.4.2 利用ライブラリ（候補）

- CSV パース: Papa Parse など（CDN から読み込み）
- グラフ描画: Chart.js / Apache ECharts / Plotly.js のいずれか（CDN）
- 地図: Leaflet（CDN）
- 上記ライブラリの最終選定は未決（→ 5.5）

#### 4.4.3 Python テストサーバ

- ローカル開発環境: Windows 11
- ローカルで静的ファイルを配信するためのテストサーバを Python で起動する
- Python 環境は **uv** で管理し、グローバル環境は汚さない

要件:

- プロジェクトルートにバッチファイル（例: `dev_server.bat`）を配置する
- `dev_server.bat` の責務:
  - uv でローカル仮想環境を用意する（必要最小限）
  - その環境で `python -m http.server` 等を実行し、静的ファイルを配信する
- Python パッケージの追加インストールは原則不要（標準ライブラリのみで完結）

### 4.5 非機能要件

- パフォーマンス:
  - 数千件程度の橋梁データであれば、操作時に体感ストレスの少ない速度で動作すること
- セキュリティ:
  - 本アプリはローカル CSV をクライアント内で処理するのみであり、サーバ送信は行わない
  - 研究用アプリケーションとして、過度なセキュリティ対策は要求しない
- ロバスト性:
  - 必須列の欠落・明らかな型不整合（数値列に文字列のみ等）については、ユーザーが原因を特定できる最小限のエラーメッセージを出す
  - 未定義の値が来た場合に「とりあえず動かす」ための場当たり的な処理は避け、仕様で定めたフォールバック（例: UNKNOWN カテゴリ）に統一する

---

## 5. 未決事項・要検討項目

### 5.1 CSV フォーマット詳細

- 文字コード（UTF-8 / Shift_JIS 等）
- 区切り文字（カンマ / タブ）
- 改行コード（CRLF / LF）
- 欠損値の表現（空欄 / `-` / `N/A` 等）

### 5.2 橋種マッピングの詳細定義

- 実データ中の `上部工（使用材料）` 値の一覧を抽出し、  
  PC / RC / 鋼 / その他 へのマッピングテーブルを作成する必要がある
- 部分一致ルール（例: `"PC"` を含む場合は PC 橋）をどこまで許容するか
- 細分類を統合するかどうかの方針（例: PRC を RC と同一視する等）

### 5.3 重複読込時の扱い

- 同じ CSV ファイルを複数回読み込んだ場合に、以下のどの方針を取るか
  - 単純にデータを二重に加算する
  - ファイルパスやハッシュで重複を検出し、2 回目以降の読込をスキップする
- 現時点では「仕様未定」とし、ユーザーの希望に応じて決定する

### 5.4 階級幅・区切りの詳細

- 橋長階級（総延長分布）
  - デフォルト案: 10m 刻み
  - 最大値に対してどこまで表示するか
- 架設年度階級
  - デフォルト案: 10 年刻み
  - 古い橋梁（年不明含む）の扱い

これらは、分析例で使われている階級に合わせることが望ましい。

### 5.5 利用ライブラリの最終選定

- グラフライブラリ（Chart.js / ECharts / Plotly.js）
- CSV パーサ（Papa Parse で確定するか）
- 地図関連補助ライブラリ（マーカ形状を変えるためのプラグイン等）

性能・実装容易性・メンテナンス性に基づき、1 セットを選定する。

### 5.6 分析例に存在するが、本 CSV では実装不能な分析

- 修繕実績
- 耐震補強状況
- 長寿命化修繕計画との紐付け
- 費用や LCC に関する分析

これらについては、分析例を確認しながら「このアプリでは対象外」であることをどこまで UI 上で明示するか未決。

---

## 6. ディレクトリ構成案

プロジェクトルート配下の基本構成は以下を想定する。

```text
/
├─ index.html
├─ js/
│   ├─ main.js          # エントリーポイント
│   ├─ charts.js        # グラフ周りの処理（分割する場合）
│   ├─ map.js           # 地図周りの処理
│   └─ data.js          # データモデル・集計ロジック
├─ css/
│   └─ style.css
├─ docs/
│   └─ 分析例.docx      # 分析例（仕様参照用、リポジトリに含めるかは要検討）
├─ dev_server.bat       # uv + python によるローカルサーバ起動
└─ (必要に応じて) pyproject.toml / uv 関連ファイル

---

## 7. 開発・運用フロー（AI エージェント向け指針）

1. この仕様書を読み込み、ディレクトリ構成と技術要件を理解すること
2. まずは UI の骨組み（`index.html` + `js/main.js`）を作成し、ダミーデータでグラフ・地図が表示できるようにする
3. 次に CSV 読み込み・解析ロジックを組み込み、ダミーデータから実データへの置き換えを行う
4. 分析例にあるグラフと本アプリのグラフを見比べ、ラベル・レイアウト・凡例をできる限り揃える
5. 橋種マッピング・判定区分の正規化など、実データ依存のロジックは必ずテーブル化し、「場当たり的な if 文」で処理しないこと
6. Python/uv はあくまでローカルテストサーバの起動にのみ使用し、アプリ本体のロジックはすべてフロントエンド（JavaScript）で完結させること

以上。