<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Municipal Bridge Dashboard</title>
    <meta name="description" content="自治体の橋梁データをブラウザだけで可視化できるダッシュボード" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230068d6'/%3E%3Cpath d='M8 21h16v-2H8zm0-4h16v-2H8zm0-4h16V11H8z' fill='white'/%3E%3C/svg%3E"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
      defer
    ></script>
    <script src="js/main.js" defer></script>
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="header-primary">
          <p class="eyebrow">Municipal Bridge Dashboard</p>
          <h1>自治体向け橋梁ダッシュボード</h1>
          <p class="lead">
            自治体ごとの橋梁施設一覧 CSV を読み込むだけで、ストック構成・健全度・橋長や架設年度の傾向、地図上での配置をまとめて確認できる
            クライアントサイドアプリです。データはブラウザ内で完結し、複数自治体の状況を安全に比較できます。
          </p>
        </div>
      </header>

      <main class="app-main">
        <section class="panel card loader-panel" aria-labelledby="csv-loader-heading">
          <div class="panel-header">
            <div>
              <p class="eyebrow">STEP 1</p>
              <h2 id="csv-loader-heading">CSV 読み込み</h2>
            </div>
            <p class="panel-description">
              xROAD の橋梁リスト（77号調査）から書き出した CSV をここで読み込みます。複数ファイルをまとめて追加すると一気に比較できます。
            </p>
          </div>
          <div class="loader-controls">
            <label class="file-input-button">
              <input type="file" accept=".csv,text/csv" multiple data-file-input />
              <span>CSV ファイルを選択</span>
            </label>
          </div>
          <div class="dropzone" data-dropzone tabindex="0">
            <div class="dropzone-inner">
              <p class="dropzone-title">ドラッグ & ドロップでも追加できます</p>
              <p class="dropzone-hint">
                1 ファイルに 1 自治体をまとめた CSV を推奨します。読み込みはブラウザ内で完結し、完了するとすぐにグラフへ反映されます。
              </p>
            </div>
          </div>
        </section>

        <section class="panel-row">
          <article class="panel card dataset-panel" aria-labelledby="dataset-heading">
            <div class="panel-header">
              <div>
                <p class="eyebrow">STEP 2</p>
                <h2 id="dataset-heading">読み込み済み dataset</h2>
              </div>
              <p class="panel-description">
                ファイル名、自治体名、橋梁数、延長、点検進捗を確認し、ON/OFF を切り替えられます。切り替えはチャート・地図にも反映されます。
              </p>
            </div>
            <p class="dataset-empty" data-dataset-empty>
              dataset はまだありません。CSV を取り込むとここに一覧が表示されます。
            </p>
            <ul class="dataset-list" data-dataset-list aria-live="polite"></ul>
          </article>

          <article class="panel card filter-panel" aria-labelledby="filter-heading">
            <div class="panel-header">
              <div>
                <p class="eyebrow">STEP 3</p>
                <h2 id="filter-heading">フィルタ & 表示設定</h2>
              </div>
              <p class="panel-description">
                橋種や点検判定区分、チャートの集計単位を切り替えて、知りたい条件だけに絞り込めます。
              </p>
            </div>
            <div class="filter-section">
              <p class="filter-label">橋種カテゴリ</p>
              <div class="chip-group" role="group" aria-label="橋種フィルタ" data-filter-bridge-types></div>
            </div>
            <div class="filter-section">
              <p class="filter-label">点検判定区分</p>
              <div class="chip-group" role="group" aria-label="点検判定フィルタ" data-filter-inspections></div>
            </div>
            <div class="filter-section">
              <p class="filter-label">橋長階級（ヒストグラムの階級幅）</p>
              <div class="range-display">
                <span>5</span>
                <input
                  type="range"
                  min="5"
                  max="50"
                  step="5"
                  value="10"
                  data-length-bin-range
                  aria-label="橋長階級幅"
                />
                <span>50</span>
              </div>
              <p class="range-hint">
                現在: <strong data-length-bin-label>10 m</strong> / 10 m 刻みは橋長分布を把握する際の目安です。
              </p>
            </div>
          </article>
        </section>

        <section class="panel card kpi-panel" aria-label="KPI ハイライト">
          <div class="kpi-grid">
            <div class="kpi-card">
              <p class="kpi-label">アクティブ dataset</p>
              <p class="kpi-value" data-kpi="datasets">0</p>
              <p class="kpi-hint">読み込み済み dataset のうち ON になっている件数</p>
            </div>
            <div class="kpi-card">
              <p class="kpi-label">橋梁総数</p>
              <p class="kpi-value" data-kpi="bridges">0</p>
              <p class="kpi-hint">フィルタ後の橋梁数</p>
            </div>
            <div class="kpi-card">
              <p class="kpi-label">総延長 (km)</p>
              <p class="kpi-value" data-kpi="length">0.0</p>
              <p class="kpi-hint">橋長(m) を km に換算した合計</p>
            </div>
            <div class="kpi-card">
              <p class="kpi-label">要注視（III/IV）</p>
              <p class="kpi-value" data-kpi="flagged">0</p>
              <p class="kpi-hint">判定区分 III / IV に該当する橋梁数</p>
            </div>
          </div>
        </section>

        <section class="chart-grid" aria-label="グラフエリア">
          <article class="panel card chart-card" aria-labelledby="stock-chart-title">
            <div class="panel-header">
              <div>
                <p class="eyebrow">橋梁ストック</p>
                <h3 id="stock-chart-title">橋種別ストック構成</h3>
              </div>
              <div class="chart-controls">
                <label class="select-label">
                  指標:
                  <select data-stock-mode>
                    <option value="count">橋梁数</option>
                    <option value="length">総延長</option>
                  </select>
                </label>
                <label class="select-label">
                  集計:
                  <select data-stock-scope>
                    <option value="bridgeType">橋種別</option>
                    <option value="dataset">自治体別</option>
                  </select>
                </label>
              </div>
            </div>
            <div class="chart-placeholder">
              <canvas id="chart-stock" aria-label="橋種別ストック構成"></canvas>
            </div>
          </article>

          <article class="panel card chart-card" aria-labelledby="rating-chart-title">
            <div class="panel-header">
              <div>
                <p class="eyebrow">健全度</p>
                <h3 id="rating-chart-title">点検判定区分の分布</h3>
              </div>
              <div class="chart-controls">
                <span class="tag tag-outline">I / II / III / IV / UNKNOWN</span>
              </div>
            </div>
            <div class="chart-placeholder">
              <canvas id="chart-rating" aria-label="点検判定区分の分布"></canvas>
            </div>
          </article>

          <article class="panel card chart-card" aria-labelledby="length-chart-title">
            <div class="panel-header">
              <div>
                <p class="eyebrow">延長分布</p>
                <h3 id="length-chart-title">橋長階級ヒストグラム</h3>
              </div>
              <div class="chart-controls">
                <span class="tag">橋種フィルタ連動</span>
              </div>
            </div>
            <div class="chart-placeholder">
              <canvas id="chart-length" aria-label="橋長階級ヒストグラム"></canvas>
            </div>
          </article>

          <article class="panel card chart-card" aria-labelledby="year-chart-title">
            <div class="panel-header">
              <div>
                <p class="eyebrow">架設年</p>
                <h3 id="year-chart-title">架設年度分布</h3>
              </div>
              <div class="chart-controls">
                <label class="select-label">
                  粒度:
                  <select data-year-grouping>
                    <option value="decade">10 年階級</option>
                    <option value="year">1 年</option>
                  </select>
                </label>
              </div>
            </div>
            <div class="chart-placeholder">
              <canvas id="chart-year" aria-label="架設年度分布"></canvas>
            </div>
          </article>
        </section>

        <section class="panel card map-panel" aria-labelledby="map-heading">
          <div class="panel-header">
            <div>
              <p class="eyebrow">ロケーション</p>
              <h2 id="map-heading">地理的分布</h2>
            </div>
            <p class="panel-description">
              地図上に橋梁をプロットし、判定区分は色、橋種は形状で表現します。自治体ごとの表示切替は dataset カードから行えます。
            </p>
          </div>
          <div class="map-canvas" id="map" role="img" aria-label="橋梁マップ"></div>
          <p class="map-info">
            表示中の橋梁: <strong data-map-count>0</strong> 件 /
            緯度経度欠損: <strong data-map-missing>0</strong> 件
          </p>
          <div class="map-legends">
            <div>
              <p class="legend-title">点検判定区分</p>
              <ul class="legend-list">
                <li><span class="legend-swatch swatch-i"></span>I（健全）</li>
                <li><span class="legend-swatch swatch-ii"></span>II（予防保全）</li>
                <li><span class="legend-swatch swatch-iii"></span>III（早期措置）</li>
                <li><span class="legend-swatch swatch-iv"></span>IV（緊急措置）</li>
                <li><span class="legend-swatch swatch-unknown"></span>UNKNOWN</li>
              </ul>
            </div>
            <div>
              <p class="legend-title">橋種カテゴリ</p>
              <ul class="legend-list">
                <li><span class="legend-shape marker-shape-pc"></span>PC 橋</li>
                <li><span class="legend-shape marker-shape-rc"></span>RC 橋</li>
                <li><span class="legend-shape marker-shape-steel"></span>鋼橋</li>
                <li><span class="legend-shape marker-shape-other"></span>その他</li>
              </ul>
            </div>
          </div>
        </section>

        <section class="panel card notes-panel" aria-labelledby="notes-heading">
          <div class="panel-header">
            <div>
              <p class="eyebrow">ガイダンス</p>
              <h2 id="notes-heading">ご利用上の注意</h2>
            </div>
          </div>
          <ul class="notes-list">
            <li>CSV はブラウザ内でのみ扱い、ページを閉じると読み込み内容はリセットされます。</li>
            <li>同じファイルを再度読み込むと別 dataset として追加されます。重複が不要な場合は dataset リストで OFF にしてください。</li>
            <li>緯度・経度が入力されていない橋梁は地図には表示されませんが、グラフ集計には含まれます。</li>
            <li>橋種や判定区分の表記揺れは可能な範囲で自動調整されますが、正確な値を入力するほど結果が安定します。</li>
          </ul>
        </section>
      </main>

      <footer class="app-footer">
        <p>Municipal Bridge Dashboard — ローカル CSV を安全に可視化</p>
      </footer>
    </div>
  </body>
</html>
